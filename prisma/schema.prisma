// Prisma Schema za Osnovci MVP v1
// Modern best practices: relations, indexes, timestamps

generator client {
  provider = "prisma-client-js"
  // Uncomment for PostgreSQL full-text search support
  // previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

// ============================================
// DATABASE CONFIGURATION
// ============================================
// Production-ready PostgreSQL with connection pooling
// Supports: Supabase, Neon, Railway, or self-hosted PostgreSQL

// Development: SQLite (current)
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Production: PostgreSQL (uncomment when deploying)
// datasource db {
//   provider  = "postgresql"
//   url       = env("DATABASE_URL")
//   directUrl = env("DATABASE_URL_UNPOOLED")
//   relationMode = "prisma"
// }

// Development fallback: SQLite (set DATABASE_URL="file:./dev.db")
// For local dev without PostgreSQL:
// datasource db {
//   provider = "sqlite"
//   url      = env("DATABASE_URL")
// }

// ============================================
// USER & AUTHENTICATION
// ============================================

enum UserRole {
  STUDENT
  GUARDIAN
}

enum Language {
  SR_LATN // Srpski latinica
  SR_CYRL // Srpski ćirilica
  EN // English
}

enum Theme {
  LIGHT
  DARK
  AUTO
}

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  phone         String?   @unique
  password      String? // Hashed with bcrypt
  role          UserRole
  locale        Language  @default(SR_LATN)
  theme         Theme     @default(AUTO)
  pinCode       String? // Encrypted PIN for quick access
  biometric     Boolean   @default(false)
  emailVerified DateTime? // NULL = nije verificiran, DateTime = verificiran
  dateOfBirth   DateTime? // COPPA compliance - age verification
  
  // Two-Factor Authentication (2FA/TOTP)
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String? // Encrypted TOTP secret
  backupCodes      String? // Encrypted JSON array of backup codes
  
  // Notification Preferences (JSON)
  notificationSettings Json? // { homeworkReminders: true, emailNotifications: true, pushNotifications: true }
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  student  Student?
  guardian Guardian?
  sessions Session[]
  biometricCredentials BiometricCredential[] // WebAuthn credentials
  pushSubscriptions PushSubscription[] // Web Push Notifications

  @@index([email])
  @@index([phone])
  @@index([role]) // For role-based queries
  @@index([emailVerified]) // For filtering verified users
  @@map("users")
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  token          String   @unique
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  
  // Device tracking
  deviceType String? // "mobile", "tablet", "desktop"
  deviceName String? // "iPhone 15 Pro", "Chrome on Windows"
  browser    String? // "Chrome 120.0"
  os         String? // "iOS 17.2", "Windows 11"
  ipAddress  String? // "192.168.1.100"
  userAgent  String? // Full user agent string

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([userId, lastActivityAt])
  @@index([expiresAt])
  @@index([userId, expiresAt]) // For active session cleanup
  @@map("sessions")
}

// Biometric Credentials (WebAuthn)
// For passwordless authentication via Face ID, Fingerprint, Windows Hello
model BiometricCredential {
  id        String   @id @default(cuid())
  userId    String
  
  // WebAuthn credential data
  credentialID        String @unique // Base64URL encoded
  credentialPublicKey Bytes          // Public key for verification
  counter             BigInt @default(0) // Signature counter (prevents replay attacks)
  
  // Device info
  deviceType String? // "platform" (Face ID, Touch ID) or "cross-platform" (YubiKey)
  deviceName String? // "iPhone 15 Pro", "MacBook Pro M3"
  
  // Metadata
  transports String? // Comma-separated: "usb,nfc,ble,internal"
  
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([credentialID])
  @@index([userId, lastUsedAt]) // For "recently used" queries
  @@map("biometric_credentials")
}

// ============================================
// PROFILES
// ============================================

enum BloodType {
  A_POSITIVE // A+
  A_NEGATIVE // A-
  B_POSITIVE // B+
  B_NEGATIVE // B-
  AB_POSITIVE // AB+
  AB_NEGATIVE // AB-
  O_POSITIVE // O+
  O_NEGATIVE // O-
  UNKNOWN // Nepoznata
}

enum Gender {
  MALE // Muški
  FEMALE // Ženski
  OTHER // Drugo
  PREFER_NOT_TO_SAY // Ne želi da navede
}

model Student {
  id        String    @id @default(cuid())
  userId    String    @unique
  name      String
  school    String
  grade     Int // Razred: 1-8
  class     String // Odeljenje: 1, 2, 3...
  avatar    String?
  birthDate DateTime?
  gender    Gender? // Pol (opciono)
  bio       String? // Kratak opis učenika
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // COPPA/GDPR Compliance
  age                  Int? // Calculated from birthDate
  parentalConsentGiven Boolean   @default(false)
  parentalConsentDate  DateTime?
  parentalConsentEmail String? // Email roditelja koji je dao pristanak
  accountActive        Boolean   @default(true) // False dok nema consent

  // Osnovne informacije
  jmbg    String? // JMBG broj (opciono, za školu)
  address String? // Adresa stanovanja

  // Fizičke karakteristike
  height       Float? // Visina u cm
  weight       Float? // Težina u kg
  clothingSize String? // Veličina garderobe (za školske aktivnosti)
  hasGlasses   Boolean @default(false) // Da li nosi naočare

  // Zdravstvene informacije
  bloodType        BloodType @default(UNKNOWN)
  allergies        String? // JSON array ili text sa alergijama (hrana, lekovi, polen, itd.)
  chronicIllnesses String? // Hronična oboljenja (astma, dijabetes, epilepsija)
  medications      String? // Terapija/lekovi koje trenutno uzima
  vaccinations     String? // Vakcinacioni karton - JSON sa datumima
  healthNotes      String? // Dodatne zdravstvene napomene
  specialNeeds     String? // Posebne potrebe (dijeta, pristupačnost)

  // Kontakt informacije za hitne slučajeve
  primaryDoctor          String? // Primarni lekar (ime i telefon)
  primaryDoctorPhone     String?
  dentist                String? // Stomatolog (ime i telefon)
  dentistPhone           String?
  emergencyContact1      String? // Kontakt u hitnim slučajevima 1 (ime i telefon)
  emergencyContact1Phone String?
  emergencyContact2      String? // Kontakt u hitnim slučajevima 2
  emergencyContact2Phone String?

  // Aktivnosti i interesovanja
  hobbies    String? // Hobiji i interesovanja
  sports     String? // Sportovi koje trenira
  activities String? // Vannastavne aktivnosti
  notes      String? // Opšte napomene

  // Relations
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  links           Link[]
  homework        Homework[]
  schedule        ScheduleEntry[]
  events          Event[]
  subjects        StudentSubject[]
  grades          Grade[]
  gamification    Gamification?
  parentalConsent ParentalConsent[] // Consent requests for this student

  @@index([userId])
  @@index([school, grade, class])
  @@index([parentalConsentGiven])
  @@map("students")
}

// ============================================
// PARENTAL CONSENT (COPPA/GDPR Compliance)
// ============================================

enum ConsentStatus {
  PENDING   // Čeka verifikaciju
  VERIFIED  // Verifikovan od strane roditelja
  EXPIRED   // Istekao (6h)
  REVOKED   // Povučen
}

model ParentalConsent {
  id        String   @id @default(cuid())
  studentId String   // ID učenika koji čeka pristanak
  
  // Kod za verifikaciju (6-digit)
  code      String   @unique // Format: "123456"
  
  // Roditelj koji daje pristanak
  parentEmail String  // Email roditelja
  parentName  String? // Ime roditelja (opciono)
  
  // Status i vremena
  status      ConsentStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  expiresAt   DateTime      // Auto-expire nakon 6h
  verifiedAt  DateTime?     // Kada je verifikovan
  revokedAt   DateTime?     // Kada je povučen
  
  // Tracking
  ipAddress   String?  // IP adresa pri verifikaciji
  userAgent   String?  // User agent pri verifikaciji
  
  // Metadata
  emailSentAt DateTime? // Kada je email poslat
  attempts    Int       @default(0) // Broj pokušaja verifikacije
  
  // Relation
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([code])
  @@index([parentEmail])
  @@index([status])
  @@index([code, status]) // Za verifikaciju - aktivni kodovi
  @@index([studentId, status]) // Za student consent check
  @@index([expiresAt]) // Za cleanup job
  @@index([createdAt]) // Za analytics
  @@map("parental_consents")
}

// ============================================
// ACTIVITY LOG (Parental Oversight)
// ============================================

enum ActivityType {
  LOGIN
  HOMEWORK_CREATED
  HOMEWORK_UPDATED
  HOMEWORK_DELETED
  PHOTO_UPLOADED
  PASSWORD_CHANGED
  PROFILE_UPDATED
  PARENT_LINKED
  PARENT_REMOVED
  SECURITY_INCIDENT
}

model ActivityLog {
  id          String       @id @default(cuid())
  studentId   String
  type        ActivityType
  description String
  metadata    Json? // Additional data
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime     @default(now())

  @@index([studentId])
  @@index([studentId, createdAt])
  @@index([type])
  @@index([type, createdAt]) // Za filtering by type with date sort
  @@index([studentId, type, createdAt]) // Za student activity timeline filtering
  @@map("activity_logs")
}

model Guardian {
  id        String   @id @default(cuid())
  userId    String   @unique
  name      String
  avatar    String?
  pinHash   String? // Bcrypt hashed PIN for parental lock
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  links Link[]

  @@index([userId])
  @@map("guardians")
}

// ============================================
// FAMILY LINKING (Roditelj ↔ Učenik)
// ============================================

model Link {
  id          String    @id @default(cuid())
  guardianId  String
  studentId   String
  linkCode    String    @unique // 6-digit code for pairing
  isActive    Boolean   @default(true)
  permissions Json? // Custom permissions object
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // Link code expiry

  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([guardianId, studentId])
  @@index([linkCode])
  @@index([guardianId])
  @@index([studentId])
  @@index([linkCode, expiresAt]) // Za active link code validation
  @@index([guardianId, studentId, isActive]) // Za active links filter
  @@map("links")
}

// Link Verification for Stranger Danger Protection
// Multi-step QR verification process
model LinkVerification {
  id String @id @default(cuid())
  
  studentId  String
  guardianId String
  linkCode   String @unique // 6-char code
  emailCode  String // 8-char email verification code
  
  step VerificationStep @default(QR_SCANNED)
  
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([linkCode])
  @@index([studentId])
  @@index([guardianId])
  @@index([expiresAt]) // For cleanup of expired verifications
  @@index([linkCode, step, expiresAt]) // For validation queries
  @@map("link_verifications")
}

enum VerificationStep {
  QR_SCANNED     // Step 1: Guardian scanned QR
  CHILD_APPROVED // Step 2: Child approved on device
  EMAIL_SENT     // Step 3: Email sent to guardian
  VERIFIED       // Step 4: Email code verified (ready to create Link)
}

// ============================================
// SUBJECTS (Predmeti)
// ============================================

model Subject {
  id        String   @id @default(cuid())
  name      String // Matematika, Srpski, Engleski...
  color     String   @default("#3b82f6") // Hex color
  icon      String? // Emoji or icon name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  students StudentSubject[]
  homework Homework[]
  schedule ScheduleEntry[]
  grades   Grade[]

  @@map("subjects")
}

// ============================================
// GRADES (Ocene)
// ============================================

model Grade {
  id          String   @id @default(cuid())
  studentId   String
  subjectId   String
  grade       String // 1-5 ili A-F
  category    String // Kontrolni, Usmeno, Domaći, Pismeni
  description String?
  date        DateTime @default(now())
  weight      Int      @default(1) // Ponder ocene (1-3)
  version     Int      @default(1) // Optimistic locking version
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([subjectId])
  @@index([date])
  @@index([studentId, subjectId, date]) // Za prikaz ocena po predmetu i datumu
  @@index([studentId, date]) // Za timeline prikaz
  @@index([category, studentId]) // Za filtriranje po kategoriji
  @@map("grades")
}

// Many-to-many: Student can have custom subjects
model StudentSubject {
  id        String   @id @default(cuid())
  studentId String
  subjectId String
  notes     String? // Custom notes per student
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
  @@map("student_subjects")
}

// ============================================
// HOMEWORK (Domaći zadaci + Dokazi)
// ============================================

enum Priority {
  NORMAL
  IMPORTANT
  URGENT
}

enum HomeworkStatus {
  ASSIGNED // Dodeljeno
  IN_PROGRESS // U toku
  DONE // Gotovo
  SUBMITTED // Poslato
  REVIEWED // Pregledano od roditelja
  REVISION // Traži doradu
}

model Homework {
  id          String         @id @default(cuid())
  studentId   String
  subjectId   String
  title       String
  description String?
  dueDate     DateTime
  priority    Priority       @default(NORMAL)
  status      HomeworkStatus @default(ASSIGNED)
  notes       String? // Učenikove beleške
  reviewNote  String? // Roditeljska napomena
  reviewedAt  DateTime?
  version     Int            @default(1) // Optimistic locking version
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  student     Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject     Subject      @relation(fields: [subjectId], references: [id])
  attachments Attachment[]

  @@index([studentId])
  @@index([subjectId])
  @@index([dueDate])
  @@index([status])
  // Compound indexes za performance
  @@index([studentId, status])
  @@index([studentId, dueDate, status])
  @@index([status, dueDate])
  @@index([studentId, priority, dueDate]) // Za prioritizovan prikaz
  @@index([priority, status, dueDate]) // Za globalni "sve urgentne" query
  
  // PostgreSQL full-text search (pg_trgm extension required) - ONLY FOR POSTGRESQL
  // Run: CREATE EXTENSION IF NOT EXISTS pg_trgm;
  // @@index([title(ops: raw("gin_trgm_ops"))], type: Gist)
  // @@index([description(ops: raw("gin_trgm_ops"))], type: Gist)
  
  @@map("homework")
}

// ============================================
// ATTACHMENTS (Dokazi - slike, video, PDF)
// ============================================

enum AttachmentType {
  IMAGE
  VIDEO
  PDF
  AUDIO
}

model Attachment {
  id         String         @id @default(cuid())
  homeworkId String
  type       AttachmentType
  fileName   String
  fileSize   Int // bytes
  mimeType   String
  localUri   String? // Za offline
  remoteUrl  String? // Cloud storage URL
  thumbnail  String? // Thumbnail URL za slike/video
  width      Int?
  height     Int?
  duration   Int? // Za video/audio (sekunde)
  uploadedAt DateTime       @default(now())
  syncedAt   DateTime? // Kad je sinhronizovano sa cloud-om

  homework Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@index([homeworkId])
  @@index([type, uploadedAt]) // Za filtering by type with date sort
  @@index([homeworkId, syncedAt]) // Za sync status check
  @@index([uploadedAt]) // For recent uploads queries
  @@map("attachments")
}

// ============================================
// SCHEDULE (Raspored časova)
// ============================================

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model ScheduleEntry {
  id        String    @id @default(cuid())
  studentId String
  subjectId String
  dayOfWeek DayOfWeek
  startTime String // "08:00"
  endTime   String // "08:45"
  room      String? // Učionica
  notes     String? // "Poneti pribor za crtanje"
  isAWeek   Boolean   @default(true) // A smena
  isBWeek   Boolean   @default(true) // B smena
  version   Int       @default(1) // Optimistic locking version
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id])

  @@index([studentId])
  @@index([subjectId])
  @@index([dayOfWeek])
  // Compound indexes
  @@index([studentId, dayOfWeek])
  @@index([studentId, dayOfWeek, startTime]) // For schedule ordering
  @@map("schedule_entries")
}

// ============================================
// EVENTS (Kontrolni, izleti, sastanci)
// ============================================

enum EventType {
  EXAM // Kontrolni/pismeni
  MEETING // Roditeljski sastanak
  TRIP // Izlet
  COMPETITION // Takmičenje
  OTHER
}

model Event {
  id          String    @id @default(cuid())
  studentId   String
  type        EventType
  title       String
  description String?
  dateTime    DateTime
  location    String?
  notes       String?
  notifyAt    DateTime? // Kad poslati notifikaciju
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([dateTime])
  @@index([type])
  // Compound indexes
  @@index([studentId, dateTime])
  @@index([studentId, type, dateTime])
  @@index([type, dateTime]) // Za globalni event calendar
  @@index([dateTime, type]) // Za upcoming events by type
  @@map("events")
}

// ============================================
// NOTIFICATIONS (Push notifikacije)
// ============================================

enum NotificationType {
  HOMEWORK_DUE
  HOMEWORK_SUBMITTED
  HOMEWORK_REVIEWED
  HOMEWORK_REMINDER
  HOMEWORK_OVERDUE
  EVENT_REMINDER
  SCHEDULE_CHANGE
  LINK_REQUEST
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json? // Dodatni podaci (deprecated - use metadata)
  metadata  Json? // Structured metadata (homeworkId, studentId, etc)
  read      Boolean          @default(false)
  isRead    Boolean          @default(false) // Deprecated - use 'read'
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([isRead])
  @@index([createdAt])
  // Compound indexes
  @@index([userId, read])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([userId, read, createdAt]) // Za unread notifications timeline
  @@index([userId, isRead, createdAt])
  @@index([type, userId]) // Za notification filtering by type
  @@map("notifications")
}

// ============================================
// ANALYTICS (Za roditeljske izveštaje)
// ============================================

model WeeklyReport {
  id                String   @id @default(cuid())
  studentId         String
  weekStart         DateTime
  weekEnd           DateTime
  totalHomework     Int      @default(0)
  completedHomework Int      @default(0)
  lateHomework      Int      @default(0)
  subjectBreakdown  Json // { "Matematika": { total: 5, completed: 4 }, ... }
  generatedAt       DateTime @default(now())

  @@index([studentId])
  @@index([weekStart])
  @@index([studentId, weekStart]) // Za student weekly reports
  @@index([weekStart, weekEnd]) // Za date range queries
  @@map("weekly_reports")
}

// ============================================
// GAMIFICATION (XP, Levels, Achievements)
// ============================================

enum AchievementType {
  // Homework Achievements
  FIRST_HOMEWORK        // Prvi domaći zadatak
  HOMEWORK_5            // 5 domaćih zadataka
  HOMEWORK_10           // 10 domaćih zadataka
  HOMEWORK_25           // 25 domaćih zadataka
  HOMEWORK_50           // 50 domaćih zadataka
  HOMEWORK_100          // 100 domaćih zadataka
  ALL_HOMEWORK_WEEK     // Svi domaći u nedelji
  ALL_HOMEWORK_MONTH    // Svi domaći u mesecu
  
  // Streak Achievements
  STREAK_3              // 3 dana streak
  STREAK_7              // 7 dana streak
  STREAK_14             // 14 dana streak
  STREAK_30             // 30 dana streak
  STREAK_60             // 60 dana streak
  STREAK_100            // 100 dana streak
  
  // Level Achievements
  LEVEL_5               // Nivo 5
  LEVEL_10              // Nivo 10
  LEVEL_20              // Nivo 20
  LEVEL_30              // Nivo 30
  LEVEL_50              // Nivo 50
  
  // XP Achievements
  XP_500                // 500 XP
  XP_1000               // 1000 XP
  XP_2500               // 2500 XP
  XP_5000               // 5000 XP
  XP_10000              // 10000 XP
  
  // Grade Achievements
  FIRST_GRADE_5         // Prva petica
  GRADE_5_STREAK_3      // 3 petice zaredom
  GRADE_5_STREAK_5      // 5 petica zaredom
  GRADE_5_STREAK_10     // 10 petica zaredom
  PERFECT_WEEK          // Sve petice u nedelji
  PERFECT_MONTH         // Sve petice u mesecu
  GRADE_AVG_45          // Prosek 4.5
  GRADE_AVG_48          // Prosek 4.8
  GRADE_AVG_50          // Prosek 5.0
  
  // Time-based Achievements
  EARLY_BIRD            // Rano jutro (pre 7h)
  NIGHT_OWL             // Kasno uveče (posle 22h)
  WEEKEND_WARRIOR       // Vikend aktivnost
  EARLY_SUBMISSION      // Rana predaja
  EARLY_SUBMISSION_10   // 10 ranih predaja
  EARLY_SUBMISSION_25   // 25 ranih predaja
  
  // Speed Achievements
  SPEED_DEMON           // Brzo završavanje
  SPEEDRUNNER_5         // 5 brzih završetaka
  SPEEDRUNNER_10        // 10 brzih završetaka
  LIGHTNING_FAST        // Munja brz
  
  // Subject Achievements
  SUBJECT_MASTER        // Majstor predmeta
  ALL_SUBJECTS_5        // Sve petice iz svih predmeta
  SUBJECT_SPECIALIST    // Specialist za predmet
  
  // Social Achievements
  HELPER                // Pomoćnik
  SOCIAL_BUTTERFLY      // Druželjubiv
  TEAM_PLAYER           // Timski igrač
  
  // Consistency Achievements
  CONSISTENT_7          // 7 dana konzistentnosti
  CONSISTENT_30         // 30 dana konzistentnosti
  CONSISTENT_90         // 90 dana konzistentnosti
  PERFECTIONIST         // Perfekcionist
  
  // Special Achievements
  COMEBACK_KID          // Povratak posle pauze
  EXPLORER              // Istraživač
  OVERACHIEVER          // Prekoračivač
  COLLECTOR             // Kolekcionar
  TOP_STUDENT           // Najbolji učenik
  LEADERBOARD_TOP_3     // Top 3 na leaderboard-u
  LEADERBOARD_TOP_10    // Top 10 na leaderboard-u
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

model Gamification {
  id                String    @id @default(cuid())
  studentId         String    @unique
  level             Int       @default(1)
  xp                Int       @default(0)
  totalXPEarned     Int       @default(0)
  totalHomeworkDone Int       @default(0)
  streak            Int       @default(0)
  longestStreak     Int       @default(0)
  lastActivityDate  DateTime?
  
  // Enhanced tracking
  weeklyXP          Int       @default(0)
  monthlyXP         Int       @default(0)
  lastWeekReset     DateTime  @default(now())
  lastMonthReset    DateTime  @default(now())
  perfectWeeks      Int       @default(0)
  earlySubmissions  Int       @default(0)
  weekendTasks      Int       @default(0)
  nightTasks        Int       @default(0)
  fastCompletions   Int       @default(0)
  
  // Streak freeze power-up
  streakFreezes     Int       @default(0)
  lastStreakFreeze  DateTime?
  
  // Privacy & preferences
  showOnLeaderboard Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  achievements Achievement[]

  @@index([studentId])
  @@index([level]) // Za leaderboard queries
  @@index([xp, level]) // Za ranking i level progression
  @@index([weeklyXP]) // Za weekly leaderboard
  @@index([monthlyXP]) // Za monthly leaderboard
  @@index([showOnLeaderboard, xp]) // Za filtered leaderboard
  @@map("gamification")
}

model Achievement {
  id             String            @id @default(cuid())
  gamificationId String
  type           AchievementType
  title          String
  description    String?
  icon           String?
  xpReward       Int               @default(0)
  rarity         AchievementRarity @default(COMMON)
  unlockedAt     DateTime          @default(now())
  
  // Enhanced progress tracking
  progress       Int?              @default(0) // Current progress towards achievement
  target         Int?              // Target value to unlock (if applicable)
  isHidden       Boolean           @default(false) // Secret achievements
  category       String?           // Grouping (e.g., "Homework", "Social", "Streak")

  gamification Gamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  @@unique([gamificationId, title])
  @@index([gamificationId])
  @@index([type])
  @@index([gamificationId, type]) // Za filtering achievements by type
  @@index([rarity, unlockedAt]) // Za sorting by rarity and date
  @@index([isHidden]) // Za filtering secret achievements
  @@map("achievements")
}

// ============================================
// EMAIL VERIFICATION
// ============================================

model VerificationToken {
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@id([email, token])
  @@index([email])
  @@index([expires])
  @@map("verification_tokens")
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String   // Public key for encryption
  auth      String   // Auth secret for encryption
  isActive  Boolean  @default(true)
  lastUsed  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
  @@index([endpoint])
  @@map("push_subscriptions")
}

// ============================================
// NOTIFICATION PREFERENCES (Granular Control)
// ============================================

enum NotificationChannel {
  EMAIL      // Email notifikacije
  PUSH       // Browser push notifications
  IN_APP     // In-app notifikacije (UI bell icon)
}

enum NotificationEventType {
  // Homework events
  HOMEWORK_ASSIGNED      // Novi domaći zadatak dodeljen
  HOMEWORK_DUE_SOON      // Domaći uskoro ističe (24h)
  HOMEWORK_OVERDUE       // Domaći je prekoračen
  HOMEWORK_SUBMITTED     // Domaći predat (za roditelje)
  HOMEWORK_REVIEWED      // Domaći pregledan i ocenjen
  
  // Grade events
  GRADE_ADDED            // Nova ocena dodata
  GRADE_UPDATED          // Ocena izmenjena
  
  // Schedule events
  SCHEDULE_CHANGED       // Raspored promenjen
  EVENT_REMINDER         // Podsetnik za događaj (kontrolni, sastanak)
  
  // Family events
  LINK_REQUEST           // Zahtev za povezivanje roditelj-dete
  LINK_APPROVED          // Veza odobrena
  
  // Safety & moderation
  CONTENT_MODERATION     // Neprikladan sadržaj detektovan
  SAFETY_ALERT           // Bezbednosni alert
  
  // Account events
  LOGIN_NEW_DEVICE       // Prijava sa novog uređaja
  PASSWORD_CHANGED       // Lozinka promenjena
  TWO_FACTOR_ENABLED     // 2FA omogućen
}

model NotificationPreference {
  id        String                  @id @default(cuid())
  userId    String                  // User ID (student ili guardian)
  
  // Event type
  eventType NotificationEventType
  
  // Channels (per-event granular control)
  emailEnabled  Boolean @default(true)
  pushEnabled   Boolean @default(true)
  inAppEnabled  Boolean @default(true)
  
  // Timing preferences (optional)
  quietHoursStart Int? // Start hour (0-23) for quiet hours
  quietHoursEnd   Int? // End hour (0-23) for quiet hours
  
  // Frequency control
  digest        Boolean @default(false) // Group notifications into daily digest
  instantOnly   Boolean @default(false) // Only instant notifications (no digest)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, eventType]) // One preference per event type per user
  @@index([userId])
  @@index([eventType])
  @@index([userId, emailEnabled])
  @@index([userId, pushEnabled])
  @@index([userId, inAppEnabled])
  @@map("notification_preferences")
}

// ============================================
// CONTENT MODERATION
// ============================================

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum ContentType {
  HOMEWORK_TITLE
  HOMEWORK_DESCRIPTION
  HOMEWORK_NOTE
  GRADE_NOTE
  SCHEDULE_NOTE
  PROFILE_BIO
  ATTACHMENT_FILENAME
}

model ModerationLog {
  id String @id @default(cuid())

  // Content details
  contentType  ContentType
  contentId    String // ID of homework, grade, etc.
  originalText String // Original content
  moderatedText String? // Filtered/moderated version

  // User context
  userId   String
  studentId String?
  
  // Moderation results
  status       ModerationStatus @default(PENDING)
  flagged      Boolean          @default(false)
  severity     String?          // none, mild, moderate, severe, critical
  flaggedWords String?          // JSON array of flagged words
  categories   Json?            // AI moderation categories

  // AI moderation scores
  aiProvider      String? // openai, aws-rekognition
  aiConfidence    Float?  // 0-100
  aiCategories    Json?   // Detailed AI results
  
  // Personal info detection
  hasPII          Boolean @default(false)
  piiTypes        String? // email, phone, address, jmbg

  // Actions taken
  actionTaken     String? // allow, warn, filter, block, flag
  notifyParent    Boolean @default(false)
  parentNotified  Boolean @default(false)
  parentNotifiedAt DateTime?

  // Review tracking
  reviewedBy   String? // Admin user ID
  reviewedAt   DateTime?
  reviewNotes  String?

  // Metadata
  ipAddress    String?
  userAgent    String?
  metadata     Json? // Additional context

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([studentId])
  @@index([contentType])
  @@index([status])
  @@index([flagged])
  @@index([notifyParent])
  @@index([createdAt])
  @@index([userId, contentType])
  @@index([status, flagged])
  @@index([notifyParent, parentNotified])
  @@map("moderation_logs")
}
